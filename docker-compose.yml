services:
  postgres:
    image: postgres:16-alpine
    container_name: sepa_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - sepa_pgdata:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - ${POSTGRES_PORT}:5432
    restart: unless-stopped

  postgres_test:
    image: postgres:16-alpine
    container_name: sepa_postgres_test
    environment:
      POSTGRES_USER: ${TEST_POSTGRES_USER}
      POSTGRES_PASSWORD: ${TEST_POSTGRES_PASSWORD}
      POSTGRES_DB: ${TEST_POSTGRES_DB}
    volumes:
      - sepa_pgdata_test:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - ${TEST_POSTGRES_PORT}:5432
    restart: unless-stopped

  pgadmin:
      image: dpage/pgadmin4:latest
      environment:
        PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
        PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      ports:
        - "8080:80" # Expose pgAdmin port to the host (e.g., 8080)
      depends_on:
        - postgres
        - postgres_test

  minio:
      container_name: sepa_minio
      image: minio/minio:RELEASE.2025-09-07T16-13-09Z   # pin a recent stable tag
      ports:
        - "9000:9000"     # S3 API
        - "9001:9001"     # Web console
      environment:
        MINIO_ROOT_USER: ${MINIO_USER}          
        MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD} 
      volumes:
        - minio_data:/data
      command: server /data --console-address ":9001"
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
        interval: 15s
        timeout: 5s
        retries: 10
        start_period: 10s
  createbuckets:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_USER: ${MINIO_USER}
      MINIO_PASSWORD: ${MINIO_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO at http://minio:9000...';
      mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD};
      mc mb --ignore-existing myminio/${MINIO_BUCKET} || true;
      mc policy set public myminio/${MINIO_BUCKET};
      echo 'Bucket ${MINIO_BUCKET} is ready and public';
      "


volumes:
  sepa_pgdata:
  sepa_pgdata_test:
  minio_data:
